<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/site-icon.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/site-icon.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/site-icon.jpg">
  <link rel="mask-icon" href="/images/site-icon.jpg" color="#222">
  <meta name="google-site-verification" content="bbrDOoVIlRq8ILDaV3dOe1EQ8RE8RSQBrNnrdfTplCE">
  <meta name="baidu-site-verification" content="q9emFHNSuh">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic%7CNoto+Serif:300,300italic,400,400italic,700,700italic%7CFira+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;www.aloha.org.cn&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:true,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12,&quot;width&quot;:320},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:true,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:true,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:&quot;utterances&quot;,&quot;storage&quot;:true,&quot;lazyload&quot;:true,&quot;nav&quot;:{&quot;utterances&quot;:{&quot;text&quot;:&quot;Comment with utterances&quot;,&quot;order&quot;:1}},&quot;activeClass&quot;:&quot;utterances&quot;},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:true,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;Searching...&quot;,&quot;empty&quot;:&quot;We didn&#39;t find any results for the search: ${query}&quot;,&quot;hits_time&quot;:&quot;${hits} results found in ${time} ms&quot;,&quot;hits&quot;:&quot;${hits} results found&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:-1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="Vulkan Tutorial 的学习记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="Vulkan">
<meta property="og:url" content="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/">
<meta property="og:site_name" content="Aloha&#39;s Blog">
<meta property="og:description" content="Vulkan Tutorial 的学习记录。">
<meta property="og:locale">
<meta property="og:image" content="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/result_base-code.png">
<meta property="og:image" content="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/Validation_layer_error_testing.png">
<meta property="article:published_time" content="2021-07-24T10:46:41.000Z">
<meta property="article:modified_time" content="2021-07-28T02:19:08.476Z">
<meta property="article:author" content="Qihuan Liu">
<meta property="article:tag" content="Index">
<meta property="article:tag" content="Computer Graphics">
<meta property="article:tag" content="Vulkan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/result_base-code.png">


<link rel="canonical" href="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;cn&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;www.aloha.org.cn&#x2F;Learning&#x2F;Computer&#x2F;Computer-Graphics&#x2F;Vulkan&#x2F;&quot;,&quot;path&quot;:&quot;Learning&#x2F;Computer&#x2F;Computer-Graphics&#x2F;Vulkan&#x2F;&quot;,&quot;title&quot;:&quot;Vulkan&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Vulkan | Aloha's Blog</title><script src="/js/config.js"></script><script src="/lib/fireworks.js"></script>
  





  <!-- <script src="/js/hoverdetail.js"></script> -->

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Aloha's Blog" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Aloha's Blog" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Aloha's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不乱于心，不困于情。不畏将来，不念过往。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">28</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">26</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">72</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#development-environment"><span class="nav-number">2.</span> <span class="nav-text">Development environment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#guidance-for-archlinux-users"><span class="nav-number">2.1.</span> <span class="nav-text">Guidance for ArchLinux users</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#testing-project"><span class="nav-number">2.2.</span> <span class="nav-text">Testing project</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#drawing-a-triangle"><span class="nav-number">3.</span> <span class="nav-text">Drawing a triangle</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#base-code"><span class="nav-number">3.1.</span> <span class="nav-text">Base code</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#general-structure"><span class="nav-number">3.1.1.</span> <span class="nav-text">General structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resource-management"><span class="nav-number">3.1.2.</span> <span class="nav-text">Resource management</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#integration-glfw"><span class="nav-number">3.1.3.</span> <span class="nav-text">Integration GLFW</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#instance"><span class="nav-number">3.2.</span> <span class="nav-text">Instance</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#creating-an-instance"><span class="nav-number">3.2.1.</span> <span class="nav-text">Creating an instance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#checking-for-extension-support"><span class="nav-number">3.2.2.</span> <span class="nav-text">Checking for extension support</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cleaning-up"><span class="nav-number">3.2.3.</span> <span class="nav-text">Cleaning up</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#validation-layers"><span class="nav-number">3.3.</span> <span class="nav-text">Validation layers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#what-are-validation-layers"><span class="nav-number">3.3.1.</span> <span class="nav-text">What are validation layers?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#using-validation-layers"><span class="nav-number">3.3.2.</span> <span class="nav-text">Using validation layers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#message-callback"><span class="nav-number">3.3.3.</span> <span class="nav-text">Message callback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#debugging-instance-creation-and-destruction"><span class="nav-number">3.3.4.</span> <span class="nav-text">Debugging instance creation and destruction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#testing"><span class="nav-number">3.3.5.</span> <span class="nav-text">Testing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#configuration"><span class="nav-number">3.3.6.</span> <span class="nav-text">Configuration</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#physical-devices-and-queue-families"><span class="nav-number">3.4.</span> <span class="nav-text">Physical devices and queue families</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#selecting-a-physical-device"><span class="nav-number">3.4.1.</span> <span class="nav-text">Selecting a physical device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link"><span class="nav-number">3.4.2.</span> <span class="nav-text"></span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Qihuan Liu"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Qihuan Liu</p>
  <div class="site-description" itemprop="description">追寻罗素先生的脚步，渴望寻找到我想要的答案。</div>
</div>
<div class="sidebar-quote">
<p class="sidebar-quote-content" onclick="toggleFull()">主人不来过夜半，闲敲棋子落灯花。</p>
<p class="sidebar-quote-from">——</p>
</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
<script type="text/javascript">
  var poem_part, poem_full
  jinrishici.load(function(result) {
    var sentence = document.querySelector(".sidebar-quote-content")
    var info = document.querySelector(".sidebar-quote-from")
    poem_part = sentence.innerHTML = result.data.content
    info.innerHTML = '——' + result.data.origin.dynasty + '·' + result.data.origin.author + '《' + result.data.origin.title + '》'
    const indent = "&nbsp".repeat(8)
    poem_full = indent + result.data.origin.content.join('<br/>' + indent)
  });
  var FULLYSHOWED = false;
  function toggleFull() {
    var sentence = document.querySelector(".sidebar-quote-content")
    if (FULLYSHOWED) {
      sentence.innerHTML = poem_part
      /* sentence.style["text-align"] = "left" */
      FULLYSHOWED = false
    } else {
      sentence.innerHTML = poem_full
      /* sentence.style["text-align"] = "center" */
      FULLYSHOWED = true
    }
  }
</script>
<!-- require APlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

<meting-js
  server="netease"
  type="playlist"
  id="6822976600"
  mini="false"
  fixed="false"
  list-folded="NaN"
  autoplay="false"
  volume="0.4"
  theme=""
  order="random"
  loop="all"
  preload="auto"
  mutex="true">
</meting-js>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">72</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>


  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>
      RSS
    </a>
  </div>

  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Fsb2hhaWE=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;alohaia"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmxpdS5xaWh1YW5Ab3V0bG9vay5jb20=" title="E-Mail → mailto:liu.qihuan@outlook.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <span class="exturl" data-url="aHR0cHM6Ly93d3cuc2Rpb3BpZC50b3Av" title="https:&#x2F;&#x2F;www.sdiopid.top&#x2F;">SDIOPID</span>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Fsb2hhaWE=" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qihuan Liu">
      <meta itemprop="description" content="追寻罗素先生的脚步，渴望寻找到我想要的答案。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aloha's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vulkan
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-24 18:46:41" itemprop="dateCreated datePublished" datetime="2021-07-24T18:46:41+08:00">2021-07-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-07-28 10:19:08" itemprop="dateModified" datetime="2021-07-28T10:19:08+08:00">2021-07-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Learning/" itemprop="url" rel="index"><span itemprop="name">Learning</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Learning/Computer/" itemprop="url" rel="index"><span itemprop="name">Computer</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Learning/Computer/Computer-Graphics/" itemprop="url" rel="index"><span itemprop="name">Computer Graphics</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>19 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><span class="exturl" data-url="aHR0cHM6Ly92dWxrYW4tdHV0b3JpYWwuY29tLw==">Vulkan Tutorial<i class="fa fa-external-link-alt"></i></span> 的学习记录。</p>
<span id="more"></span>
<p>推荐资源：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucGJyLWJvb2sub3JnLw==">Physically Based Rendering: From Theory To Implementation<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYXJvai5naXRodWIuaW8vZ2x0dXQv">Learning Modern 3D Graphics Programming<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JheVRyYWNpbmcvcmF5dHJhY2luZy5naXRodWIuaW8=">Ray Tracing in One Weekend Book Series<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h2 id="overview">Overview<a class="markdownIt-Anchor" href="#overview"></a></h2>
<p>要绘制一个三角形，需要以下步骤：</p>
<ol>
<li>
<p><strong>Instance and physical device selection</strong>：Vulkan 首先需要通过创建 <code>VkInstance</code> 来准备（set up）Vulkan API。创建好实例（instance）后，就可以查询 Vulkan 支持的设备并选择一个或多个 <code>VkPhysicalDevice</code> 用于后续操作。</p>
</li>
<li>
<p><strong>Logical device and queue families</strong>：选择合适的硬件设备后，需要创建一个逻辑设备 <code>VkDevice</code>。你可以使用它来通过 <code>VkPhysicalDeviceFeatures</code> 进行更详细的设置。Vulkan 执行的大多数操作，都是通过提交到一个 <code>VkQueue</code> 中异步执行的。队列（queue）是从队列族（queue family）中分配的，每个队列族在其队列中支持一组特定的操作。</p>
</li>
<li>
<p><strong>Window surface and swap chain</strong>：要将渲染的图像显示到一个窗口，还需要一个窗口表面（window surface）<code>VkSurfaceKHR</code> 和一个交换链（swap chain）<code>VkSwapChainKHR</code>。后缀 <code>KHR</code> 意思是说这两个是 Vulkan 扩展的一部分。<code>VkSurfaceKHR</code> 是一个跨平台的窗口抽象，通常通过提供一个原生窗口句柄初始化。</p>
<p>交换链是一系列最终会展示给用户的图像的集合，并负责管理图像交替用于渲染和显示。</p>
<p>一些平台允许你通过 <code>VK_KHR_display_swapchain</code> 和 <code>VK_KHR_display</code> 扩展直接将渲染到显示器上而不与窗口管理器进行交互。你可以用这一特性编写自己的窗口管理器。</p>
</li>
<li>
<p><strong>Image views and framebuffers</strong>：要绘制从交换链获取的图像，我们需要将图像包装进 <code>VkImageView</code> 和 <code>VkFramebuffer</code>。Image view 引用要使用的图像的特定部分，framebuffer 则引用用于颜色、深度和模版目标（stencil target）的 image views。由于交换链中由许多不同的图像，所以我们会抢先为每个图像创建一个 image view 和 framebuffer。</p>
</li>
<li>
<p><strong>Render passes</strong>：Render pass 描述了渲染操作中所使用的图像的类型（如用于透明度、法线的图像）、图像将被如何使用以及图像的内容将被如何处理。渲染通道只描述了图像的类型，而实际由 <code>VkFramebuffer</code> 将指定图像“插入对应的卡槽中”。</p>
</li>
<li>
<p><strong>Graphics pipeline</strong>：Vulkan 的 graphics pipeline 的创建是通过创建 <code>VkPipeline</code> 来完成的。它描述了显卡的可配置属性（configurable state），如视口大小、深度缓冲操作（depth buffer operation）以及使用 <code>VkShaderModule</code> 对象（object）的可编程属性（programmable state）。<code>VkShaderModule</code> 从着色器（shader）字节码（byte code）中创建。我们可以通过引用 render pass 来告知驱动程序哪个渲染对象将在管线中使用。</p>
<p>Vulkan 的与现存图形 APIs 不同的一大特点就是 graphics pipeline 的几乎所有配置（视口大小、clear color 等除外）都需要预先完成，如果你想对管线做任何修改，都必须重新创建整个管线。这意味着你需要预先创建许多 <code>VkPipeline</code> 对象。</p>
</li>
<li>
<p><strong>Command pools and command buffers</strong>：在前面提到的将 Vulkan 操作提交到队列中前，需要先将操作记录到一个 <code>VkCommandBuffer</code> 对象中。Command buffer 从一个 <code>VkCommandPool</code> 中分配，<code>VkCommandPool</code> 与一个特定的队列族相关。</p>
<p>要绘制一个简单的三角形，我们需要将以下操作记录到一个 command buffer 中：</p>
<ol>
<li>开始 render pass</li>
<li>绑定 graphics pipeline</li>
<li>绘制三个顶点（vertice）</li>
<li>结束 render pass</li>
</ol>
<p>由于 framebuffer 中的图像取决于交换链给的是哪张图像，我们需要为每个可能用到的图像记录一个 command buffer，并在绘制时选择正确的 command buffer。另一种低效的替代方法是在每一帧再次记录 command buffer。</p>
</li>
<li>
<p><strong>Main loop</strong>：现在绘制命令都被包装到一个 command buffer 中，主循环就非常简单了。我们先用 <code>vkAcquireNextImageKHR</code> 从交换链中获取一张图像。然后我们可以为图像选择适当的 command buffer，并用 <code>vKQueueSubmit</code> 执行。最后，我们将图像返回到交换链并用 <code>vkQueuePresentKHR</code> 显示到屏幕上。</p>
</li>
</ol>
<p>简而言之，我们需要以下步骤来绘制一个三角形：</p>
<ol>
<li>创建一个 <code>VkInstance</code> 实例</li>
<li>选择一个受支持的显卡（<code>VkPhysicalDevice</code>）</li>
<li>创建 <code>VkDevice</code> 和 <code>VkQueue</code> 用来绘制和显示</li>
<li>创建一个窗口、窗口表面（window surface）和交换链</li>
<li>将交换链包装进 <code>VkImageView</code></li>
<li>创建 render pass 来指定渲染对象及其用途</li>
<li>为 render pass 创建 framebuffer</li>
<li>设置（set up）graphics pipeline</li>
<li>为交换链中每个可能用到的图像分配一个 command buffer 并用绘制命令将其填充</li>
<li>绘制帧：从交换链中获取图像，提交正确的 command buffer，然后将图像返回到交换链中</li>
</ol>
<h2 id="development-environment">Development environment<a class="markdownIt-Anchor" href="#development-environment"></a></h2>
<p>按照 <span class="exturl" data-url="aHR0cHM6Ly92dWxrYW4tdHV0b3JpYWwuY29tL0RldmVsb3BtZW50X2Vudmlyb25tZW50I3BhZ2VfTGludXg=">Vulkan Tutorial 的说明<i class="fa fa-external-link-alt"></i></span> 安装即可。</p>
<h3 id="guidance-for-archlinux-users">Guidance for ArchLinux users<a class="markdownIt-Anchor" href="#guidance-for-archlinux-users"></a></h3>
<ul>
<li>Vulkan：<code>sudo pacman -S vulkan-icd-loader vulkan-intel nvidia-utils vulkan-devel</code>，详见 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvVnVsa2Fu">Vulkan - ArchWiki<i class="fa fa-external-link-alt"></i></span></li>
<li>GLFW：<code>sudo pacman -S glfw-x11</code> 或者 <code>sudo pacman -S glfw-wayland</code></li>
<li>GLM: <code>sudo pacman -S glm</code></li>
</ul>
<h3 id="testing-project">Testing project<a class="markdownIt-Anchor" href="#testing-project"></a></h3>
<figure class="highlight cpp"><figcaption><span>main.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLFW_INCLUDE_VULKAN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GLFW/glfw3.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLM_FORCE_RADIANS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLM_FORCE_DEPTH_ZERO_TO_ONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;glm/vec4.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;glm/mat4x4.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">glfwInit</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_CLIENT_API, GLFW_NO_API);</span><br><span class="line">    GLFWwindow* window = <span class="built_in">glfwCreateWindow</span>(<span class="number">800</span>, <span class="number">600</span>, <span class="string">&quot;Vulkan window&quot;</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> extensionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; extensionCount &lt;&lt; <span class="string">&quot; extensions supported\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    glm::mat4 matrix;</span><br><span class="line">    glm::vec4 vec;</span><br><span class="line">    <span class="keyword">auto</span> test = matrix * vec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">glfwWindowShouldClose</span>(window)) &#123;</span><br><span class="line">        <span class="built_in">glfwPollEvents</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwDestroyWindow</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwTerminate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS = -std=c++17 -O2</span><br><span class="line">LDFLAGS = -lglfw -lvulkan -ldl -lpthread -lX11 -lXxf86vm -lXrandr -lXi</span><br><span class="line"></span><br><span class="line"><span class="section">VulkanTest: main.cpp</span></span><br><span class="line">	g++ <span class="variable">$(CFLAGS)</span> -o VulkanTest main.cpp <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: test clean</span></span><br><span class="line"></span><br><span class="line"><span class="section">test: VulkanTest</span></span><br><span class="line">	./VulkanTest</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f VulkanTest</span><br></pre></td></tr></table></figure>
<p>也可以使用 CMake 而不是直接使用 Make，CMakeLists.txt 如下：</p>
<figure class="highlight cmake"><figcaption><span>CMakeLists.txt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.21</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiler flags</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++17 -O2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Project</span></span><br><span class="line"><span class="keyword">project</span>(VulkanTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executables</span></span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span></span><br><span class="line">    PRIVATE -lglfw -lvulkan -ldl -lpthread -lX11 -lXxf86vm -lXrandr -lXi</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include directories</span></span><br><span class="line"><span class="keyword">target_include_directories</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span></span><br><span class="line">    PRIVATE</span><br><span class="line">        <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="drawing-a-triangle">Drawing a triangle<a class="markdownIt-Anchor" href="#drawing-a-triangle"></a></h2>
<h3 id="base-code">Base code<a class="markdownIt-Anchor" href="#base-code"></a></h3>
<h4 id="general-structure">General structure<a class="markdownIt-Anchor" href="#general-structure"></a></h4>
<figure class="highlight cpp"><figcaption><span>main.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vulkan/vulkan.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloTriangleApplication</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">initVulkan</span>();</span><br><span class="line">        <span class="built_in">mainLoop</span>();</span><br><span class="line">        <span class="built_in">cleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initVulkan</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HelloTriangleApplication app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app.<span class="built_in">run</span>();</span><br><span class="line">    &#125; <span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125; <span class="built_in"><span class="keyword">catch</span></span> (...) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Undefined exception.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="resource-management">Resource management<a class="markdownIt-Anchor" href="#resource-management"></a></h4>
<p>在 C++ 中，有两种方式可以进行自动资源管理：<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmVzb3VyY2VfQWNxdWlzaXRpb25fSXNfSW5pdGlhbGl6YXRpb24=">RAII<i class="fa fa-external-link-alt"></i></span> 或 <code>&lt;memory&gt;</code> 头文件中的智能指针。</p>
<p>Vulkan 对象要么是通过形如 <code>VkCreateXXX</code> 的函数创建的，要么是通过形如 <code>VkAllocateXXX</code> 的函数由另一个对象分配的。当确定一个对象不再使用后，你需要分别使用对应的 <code>VkDestroyXXX</code> 或 <code>VkFreeXXX</code> 将其销毁。对不同对象，这些函数的参数有所不同，但是有一个参数是它们共有的：<code>pAllocator</code>。这个参数是一个可选参数，你可以用它来指定所创建对象的自定义内存配置器。在这个教程中，我们总是忽视这个参数，将 <code>nullptr</code> 传递给该参数。</p>
<h4 id="integration-glfw">Integration GLFW<a class="markdownIt-Anchor" href="#integration-glfw"></a></h4>
<p>Vulkan 只做离屏渲染也没问题，但是实际显示一些东西会更加令人兴奋。首先要将 <code>#include &lt;vulkan/vulkan.h&gt;</code> 替换为：</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:1-2</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLFW_INCLUDE_VULKAN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GLFW/glfw3.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这样就可以包含 GLFW 的自己的定义（definitions）并自动加载 Vulkan 的头文件。接下来在 <code>run</code> 函数中的其他函数调用前添加 <code>initWindow</code> 函数，我们将要使用这个函数来初始化 GLFW 并创建一个窗口。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:13-18</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">initWindow</span>();</span><br><span class="line">    <span class="built_in">initVulkan</span>();</span><br><span class="line">    <span class="built_in">mainLoop</span>();</span><br><span class="line">    <span class="built_in">cleanup</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在 <code>initWindow</code> 中最先应该调用 <code>glfwInit()</code> 函数，以初始化 GLFW 库。因为 GLFW 本来是被设计为创建一个 OpenGL 上下文（context）的，所以紧跟着要使用一条函数调用来告诉它不要创建 OpenGL 上下文。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:26</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glfwWindowHint</span>(GLFW_CLIENT_API, GLFW_NO_API);</span><br></pre></td></tr></table></figure>
<p>处理缩放窗口需要额外的注意，因此现在我们用另一条函数调用禁用窗口缩放。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:27</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glfwWindowHint</span>(GLFW_RESIZABLE, GLFW_FALSE);</span><br></pre></td></tr></table></figure>
<p>添加私有成员 <code>GLFWwindow* window;</code>，并在 <code>initWindow</code> 中完成其初始化。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:8-9</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> WIDTH = <span class="number">800</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> HEIGHT = <span class="number">600</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:29-29</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window = <span class="built_in">glfwCreateWindow</span>(WIDTH, HEIGHT, <span class="string">&quot;Vulkan&quot;</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>
<p>然后在添加 <code>mainloop</code> 函数的定义，使程序一直运行直到出现错误或窗口关闭。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:36-40</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">glfwWindowShouldClose</span>(window)) {</span><br><span class="line">        <span class="built_in">glfwPollEvents</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>最后，定义 <code>cleanup</code> 用来销毁窗口和结束 GLFW。</p>
<figure class="highlight cpp"><figcaption><span>00_base_code.cpp:42-46</span><a href="/code/Vulkan/00_base_code.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">glfwDestroyWindow</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwTerminate</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>编译并运行程序，出现一个标题为“Vulkan”窗口（如下图），就表明成功了，恭喜！</p>
<img data-src="/Learning/Computer/Computer-Graphics/Vulkan/result_base-code.png" class="">
<h3 id="instance">Instance<a class="markdownIt-Anchor" href="#instance"></a></h3>
<h4 id="creating-an-instance">Creating an instance<a class="markdownIt-Anchor" href="#creating-an-instance"></a></h4>
<p>最先要做的事是通过创建一个实例来初始化 Vulkan 库。这个实例是连接你的应用和 Vulkan 库的纽带，创建它需要向驱动程序指明你的应用的一些细节。</p>
<p>首先添加 <code>initVulkan</code> 函数的定义并在其中添加 <code>createInstance</code> 函数的调用。</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:34-36</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initVulkan</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">createInstance</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>另外，添加一个私有成员来保存实例。</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:23</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VkInstance instance;</span><br></pre></td></tr></table></figure>
<p>现在要创建一个实例，首先需要填充 <code>VkApplicationInfo</code> 结构体。这在技术上是可选的，但是可以为驱动提供一些信息以优化我们的程序。添加私有成员函数 <code>createInstance</code> 的定义并在函数体中添加如下内容：</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:53-59</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkApplicationInfo appInfo{};</span><br><span class="line">appInfo.sType = VK_STRUCTURE_TYPE_APPLICATION_INFO;</span><br><span class="line">appInfo.pApplicationName = <span class="string">&quot;Hello Triangle&quot;</span>;</span><br><span class="line">appInfo.applicationVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">appInfo.pEngineName = <span class="string">&quot;No Engine&quot;</span>;</span><br><span class="line">appInfo.engineVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">appInfo.apiVersion = VK_API_VERSION_1_0;</span><br></pre></td></tr></table></figure>
<p>Vulkan 中许多结构体需要在 <code>sType</code> 成员中指定类型。另外，<code>VkApplicationInfo</code> 也是许多具有 <code>pNext</code> 成员的结构之一，可以指向未来的扩展信息，不过这里我们将其留空为 <code>nullptr</code>。</p>
<p>Vulkan 中的许多信息都是通过结构体而不是函数参数传递的。我们还需要（在 <code>createInstance</code> 函数体中）填充一个非可选的 <code>VkInstanceCreateInfo</code> 结构体。这个结构体告知 Vulkan 驱动我们要用哪些全局扩展（global extensions）和验证层（validation layers）。这里的“全局”的意思是扩展汇兑整个程序生效而不是某个特定驱动。</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:61-70</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VkInstanceCreateInfo createInfo{};</span><br><span class="line">createInfo.sType = VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO;</span><br><span class="line">createInfo.pApplicationInfo = &amp;appInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> glfwExtensionCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>** glfwExtensions;</span><br><span class="line">glfwExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;glfwExtensionCount);</span><br><span class="line"></span><br><span class="line">createInfo.enabledExtensionCount = glfwExtensionCount;</span><br><span class="line">createInfo.ppEnabledExtensionNames = glfwExtensions;</span><br></pre></td></tr></table></figure>
<p>前两个成员无需过多解释；后两个参数指定了所需的全局扩展。Vulkan 是一个平台不可知的 API（platform agnostic API），需要一个扩展来与窗口系统结合。GLFW 内置了一个方便的函数 <code>glfwGetRequiredInstanceExtensions</code>，可以返回所需的扩展。</p>
<p>另外还有两个成员指定了要启用的验证层，不过这里先将其留空：</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:72</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createInfo.enabledLayerCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>现在我们已经指定了 Vulkan 创建一个实例所需的一切，终于可以发出 <code>vkCreateInstance</code> 函数调用了：</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:74-76</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">vkCreateInstance</span>(&amp;createInfo, <span class="literal">nullptr</span>, &amp;instance) != VK_SUCCESS) {</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create instance!&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>如你所见，Vulkan 函数参数的一般模式为：</p>
<ol>
<li>指向包含创建信息的结构体的指针</li>
<li>指向自定义资源配置器回调的指针</li>
<li>指向用来储存新对象句柄的变量的指针</li>
</ol>
<p>一切顺利的话，<code>instance</code> 中将会储存有新对象的句柄，函数将会返回一个 <code>VkResult</code> 值 <code>VK_SUCCESS</code>。</p>
<h4 id="checking-for-extension-support">Checking for extension support<a class="markdownIt-Anchor" href="#checking-for-extension-support"></a></h4>
<p>如果你去查看 <a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.0/man/html/vkCreateInstance.html"><code>vkCreateInstance</code></a> 的文档，你会发现有一个 <code>VK_ERROR_EXTENSION_NOT_PRESENT</code> 错误码（扩展不存在）。在前面的代码中，当收到错误码时，我们简单地抛出异常并终止程序。这对某些关键扩展，如窗口系统接口来说没有问题，但是要是我们要检查可选扩展呢？</p>
<div class="note warning"><p>在编写代码时，建议每添加一个扩展就检查一次是否出现 <code>VK_ERROR_EXTENSION_NOT_PRESENT</code> 错误码。</p>
</div>
<p>要在创建实例前获取支持的扩展的列表，可以使用 <code>vkEnumerateInstanceExtensionProperties</code> 函数。该函数需要一个指向用来储存扩展数量的变量的指针，一个用来储存每个扩展的细节的 <code>VkExtensionProperties</code> 数组以及一个（第一个）提供用来过滤扩展的验证层的可选参数参数。</p>
<p>要分配 <code>VkExtensionProperties</code> 数组，我们先需要知道扩展的数量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> extensionCount = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>
<p>然后就可以分配数组并获取扩展信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;VkExtensionProperties&gt; <span class="title">extensions</span><span class="params">(extensionCount)</span></span>;</span><br><span class="line"><span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, extensions.<span class="built_in">data</span>());</span><br></pre></td></tr></table></figure>
<p>可以用以下代码查看扩展的信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">std::cout &lt;&lt; <span class="string">&quot;available extensions:\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; extension : extensions) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&#x27;\t&#x27;</span> &lt;&lt; extension.extensionName &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，还可以用 <code>glfwGetRequiredInstanceExtensions</code> 函数获取所需扩展的列表。下面是在 <code>createInstance</code> 函数中额外添加的代码（可选）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;&#123;&#123;1 Checking for extension support</span></span><br><span class="line"><span class="comment">// Supported extensions</span></span><br><span class="line"><span class="keyword">uint32_t</span> extensionCount = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="function">std::vector&lt;VkExtensionProperties&gt; <span class="title">extensions</span><span class="params">(extensionCount)</span></span>;</span><br><span class="line"><span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, extensions.<span class="built_in">data</span>());</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;available extensions:\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; extension : extensions) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&#x27;\t&#x27;</span> &lt;&lt; extension.extensionName &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Required extensions</span></span><br><span class="line"><span class="keyword">uint32_t</span> requiredExtensionCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> ** requiredExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;requiredExtensionCount);</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;required extensions:\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; requiredExtensionCount; ++i) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&#x27;\t&#x27;</span> &lt;&lt; requiredExtensions[i] &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#125;&#125;&#125;1</span></span><br></pre></td></tr></table></figure>
<p>总的输出如下：</p>
<figure class="highlight plaintext"><figcaption><span>输出</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">available extensions:</span><br><span class="line">	VK_KHR_device_group_creation</span><br><span class="line">	VK_KHR_display</span><br><span class="line">	VK_KHR_external_fence_capabilities</span><br><span class="line">	VK_KHR_external_memory_capabilities</span><br><span class="line">	VK_KHR_external_semaphore_capabilities</span><br><span class="line">	VK_KHR_get_display_properties2</span><br><span class="line">	VK_KHR_get_physical_device_properties2</span><br><span class="line">	VK_KHR_get_surface_capabilities2</span><br><span class="line">	VK_KHR_surface</span><br><span class="line">	VK_KHR_surface_protected_capabilities</span><br><span class="line">	VK_KHR_xcb_surface</span><br><span class="line">	VK_KHR_xlib_surface</span><br><span class="line">	VK_EXT_acquire_xlib_display</span><br><span class="line">	VK_EXT_debug_report</span><br><span class="line">	VK_EXT_debug_utils</span><br><span class="line">	VK_EXT_direct_mode_display</span><br><span class="line">	VK_EXT_display_surface_counter</span><br><span class="line">	VK_KHR_wayland_surface</span><br><span class="line">required extensions:</span><br><span class="line">	VK_KHR_surface</span><br><span class="line">	VK_KHR_xcb_surface</span><br></pre></td></tr></table></figure>
<h4 id="cleaning-up">Cleaning up<a class="markdownIt-Anchor" href="#cleaning-up"></a></h4>
<p><code>VkInstance</code> 应该在程序退出前销毁。在 <code>cleanup</code> 函数中调用 <code>vkDestroyInstance</code> 函数：</p>
<figure class="highlight cpp"><figcaption><span>01_instance_creation.cpp:44-50</span><a href="/code/Vulkan/01_instance_creation.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">vkDestroyInstance</span>(instance, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwDestroyWindow</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwTerminate</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="validation-layers">Validation layers<a class="markdownIt-Anchor" href="#validation-layers"></a></h3>
<h4 id="what-are-validation-layers">What are validation layers?<a class="markdownIt-Anchor" href="#what-are-validation-layers"></a></h4>
<p>Vulkan 引入了<strong>验证层</strong>（validation layer）来进行错误检查。一个验证层的函数看起来像这样（注意函数返回值）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VkResult <span class="title">vkCreateInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> VkInstanceCreateInfo* pCreateInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> VkAllocationCallbacks* pAllocator,</span></span></span><br><span class="line"><span class="params"><span class="function">    VkInstance* instance)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pCreateInfo == <span class="literal">nullptr</span> || instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;Null pointer passed to required parameter!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> VK_ERROR_INITIALIZATION_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">real_vkCreateInstance</span>(pCreateInfo, pAllocator, instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>验证层可以自由堆叠以获得你感兴趣的功能。你可以简单地在 debug 构建（build）中启用验证层，在 release 构建中禁用验证层。</p>
<p>Vulkan 不提供任何内置的验证层，但是 LunarG Vulkan SDK 提供了一组用以检查常规错误的验证层（<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tocm9ub3NHcm91cC9WdWxrYW4tVmFsaWRhdGlvbkxheWVycw==">开源地址<i class="fa fa-external-link-alt"></i></span>）。只有在安装了验证层的环境中才可以使用验证层，对 ArchLinux 用户，请确认你安装了 vulkan-devel 软件包或单独安装了 vulkan-validation-layers 软件包。</p>
<p>在 Vulkan 中原先有两种不同类型的验证层：实例（instance）特定和设备（device）特定。原先的想法是实例验证层只检查 Vulkan 实例这样的全局对象，而设备验证层只检查与特定设备相关的函数调用。现在设备验证层已经被弃用，所有的函数调用都使用实例验证层。但规范文件仍建议为了兼容性在设备水平（level）也启用验证层。</p>
<h4 id="using-validation-layers">Using validation layers<a class="markdownIt-Anchor" href="#using-validation-layers"></a></h4>
<p>与扩展相同，验证层也需要通过指定其名称来启用。LunarG Vulkan SDK 的所用 validations 都都被绑成一捆放进了名为 <code>VK_LAYER_KHRONOS_validation</code> 的 layer 中。</p>
<p>首先添加两个配置变量来分别指定要启用的验证层和是否启用验证层，后者（<code>enableValidationLayers</code>）的值由是否在 debug 模式变异来决定。<code>NDEBUG</code> 是 C++ 标准的一部分，意思是“not debug”，可用来决定是否启用 <a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/error/assert"><code>assert</code></a> 宏。</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:13-21</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> std::vector&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; validationLayers = {</span><br><span class="line">    <span class="string">&quot;VK_LAYER_KHRONOS_validation&quot;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NDEBUG</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> enableValidationLayers = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> enableValidationLayers = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>我们添加了一个新函数 <code>checkValidationLayerSupport</code> 来检查是否所有所需的验证层都是可用的。首先使用 <code>vkEnumerateInstanceLayerProperties</code> 函数来获取所有可用的验证层，其用法与 <a href="#checking-for-extension-support">前面</a> 的 <code>vkEnumerateInstanceExtensionProperties</code> 相同。另外，还需要包含 <code>&lt;cstring&gt;</code> 库以使用 <code>strcmp</code> 函数检查是否所有的 <code>validationLayers</code> 中的层都存在于 <code>availableLayers</code>。</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:158-181</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkValidationLayerSupport</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">uint32_t</span> layerCount;</span><br><span class="line">    <span class="built_in">vkEnumerateInstanceLayerProperties</span>(&amp;layerCount, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">std::vector&lt;VkLayerProperties&gt; <span class="title">availableLayers</span><span class="params">(layerCount)</span></span>;</span><br><span class="line">    <span class="built_in">vkEnumerateInstanceLayerProperties</span>(&amp;layerCount, availableLayers.<span class="built_in">data</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* layerName : validationLayers) {</span><br><span class="line">        <span class="keyword">bool</span> layerFound = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; layerProperties : availableLayers) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(layerName, layerProperties.layerName) == <span class="number">0</span>) {</span><br><span class="line">                layerFound = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!layerFound) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>现在我们可以在 <code>createInstance</code> 函数中使用 <code>checkValidationLayerSupport</code> 函数了：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:87-89</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (enableValidationLayers &amp;&amp; !<span class="built_in">checkValidationLayerSupport</span>()) {</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;validation layers requested, but not available!&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>最后，修改 <code>VkInstanceCreateInfo</code> 的实例化以包含验证层名称：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (enableValidationLayers) &#123;</span><br><span class="line">    createInfo.enabledLayerCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(validationLayers.<span class="built_in">size</span>());</span><br><span class="line">    createInfo.ppEnabledLayerNames = validationLayers.<span class="built_in">data</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    createInfo.enabledLayerCount = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="message-callback">Message callback<a class="markdownIt-Anchor" href="#message-callback"></a></h4>
<p>验证层默认会输出调试信息到标准输出，但是我们可以通过提供一个回调函数来自己处理调试信息。这是可选的，你也可以选择 <a href="#debugging-instance-creation-and-destruction">跳过这小一节</a>。</p>
<p>要设置回调函数来处理调试信息相关细节，我们先要使用 <code>VK_EXT_debug_utils</code> 扩展来设立一个<em>调试信使</em>（debug messenger）。首先创建 <code>getRequiredExtensions</code> 函数，该函数根据验证层是否启用来返回所需扩展列表：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:144-156</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; <span class="title">getRequiredExtensions</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">uint32_t</span> glfwExtensionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>** glfwExtensions;</span><br><span class="line">    glfwExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;glfwExtensionCount);</span><br><span class="line"></span><br><span class="line">    <span class="function">std::vector&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; <span class="title">extensions</span><span class="params">(glfwExtensions, glfwExtensions + glfwExtensionCount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableValidationLayers) {</span><br><span class="line">        extensions.<span class="built_in">push_back</span>(VK_EXT_DEBUG_UTILS_EXTENSION_NAME);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> extensions;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>GLFW 指定的扩展总是必须的，调试信使的扩展则根据情况添加。注意，这里用了 <code>VK_EXT_DEBUG_UTILS_EXTENSION_NAME</code> 宏，等价于字符串 <code>&quot;VK_EXT_debug_utils&quot;</code>，但可以利用 LSP 补全功能避免打字错误。</p>
<p>现在可以在 <code>createInstance</code> 函数中使用该函数：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:103-105</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> extensions = <span class="built_in">getRequiredExtensions</span>();</span><br><span class="line">createInfo.enabledExtensionCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(extensions.<span class="built_in">size</span>());</span><br><span class="line">createInfo.ppEnabledExtensionNames = extensions.<span class="built_in">data</span>();</span><br></pre></td></tr></table></figure>
<p>现在来添加调试回调函数，用 <a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/PFN_vkDebugUtilsMessengerCallbackEXT.html"><code>PFN_vkDebugUtilsMessengerCallbackEXT</code></a> 原型创建一个名为 <code>debugCallback</code> 的函数。这里额外添加了 <a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VKAPI_ATTR.html"><code>VKAPI_ATTR</code></a> 和 <a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VKAPI_CALL.html"><code>VKAPI_CALL</code></a> 以确保该函数有 Vulkan 调用所需的正确签名。</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:183-191</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VKAPI_ATTR VkBool32 VKAPI_CALL <span class="title">debugCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessageSeverityFlagBitsEXT      messageSeverity,</span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessageTypeFlagsEXT             messageType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> VkDebugUtilsMessengerCallbackDataEXT* pCallbackData,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">void</span>*                                       pUserData)</span> </span>{</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;validation layer: &quot;</span> &lt;&lt; pCallbackData-&gt;pMessage &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> VK_FALSE;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>第一个参数指定消息的严重性，可以是以下的宏之一：</p>
<ul>
<li><code>VK_DEBUG_UTILS_MESSAGE_SEVERITY_VERBOSE_BIT_EXT</code>：诊断信息</li>
<li><code>VK_DEBUG_UTILS_MESSAGE_SEVERITY_INFO_BIT_EXT</code>：提示信息，如资源的创建</li>
<li><code>VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT</code>：警告信息，算不上错误但很可能是一个 bug</li>
<li><code>VK_DEBUG_UTILS_MESSAGE_SEVERITY_ERROR_BIT_EXT</code>：错误信息，非法并可能导致崩溃</li>
</ul>
<p>由上到下，随着严重性的增加，宏的值也逐渐增大，你可以写这样的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (messageSeverity &gt;= VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT) &#123;</span><br><span class="line">    <span class="comment">// Message is important enough to show</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个参数 <code>messageType</code> 可以是以下值：</p>
<ul>
<li><code>VK_DEBUG_UTILS_MESSAGE_TYPE_GENERAL_BIT_EXT</code>：发生了与规范（specification）和性能（performance）无关的事件</li>
<li><code>VK_DEBUG_UTILS_MESSAGE_TYPE_VALIDATION_BIT_EXT</code>：发生了违反规范或暗示可能发生错误的事件</li>
<li><code>VK_DEBUG_UTILS_MESSAGE_TYPE_PERFORMANCE_BIT_EXT</code>：潜在的 Vulkan 的非最佳用法</li>
</ul>
<p><code>pCallbackData</code> 参数指向一个包含信息本身的 <code>VkDebugUtilsMessengerCallbackDataEXT</code> 结构体，其中包含一些重要成员：</p>
<ul>
<li><code>pMessage</code>：调试信息，是一个 null-terminated 字符串</li>
<li><code>pObjects</code>：与该信息相关的 Vulkan 对象组成的的数组</li>
<li><code>objectCount</code>：数组中对象的数量</li>
</ul>
<p>最后，<code>pUserData</code> 包含一个在回调设立期间指定的指针，你可以向其传递你自己的数据。</p>
<p>剩下的就是告诉 Vulkan 这个回调函数了。可能会令人有些意外，Vulkan  中就连调试回调都是由一个句柄管理并且需要显式创建和销毁。这样一个回调是<em>调试信使</em>的一部分，你可以有任意多个。为句柄在 <code>instance</code> 下面添加一个成员：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:52</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VkDebugUtilsMessengerEXT debugMessenger;</span><br></pre></td></tr></table></figure>
<p>在 <code>initVulkan</code> 函数中添加 <code>setupDebugMessenger</code> 函数的调用。</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:63-66</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initVulkan</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">createInstance</span>();</span><br><span class="line">    <span class="built_in">setupDebugMessenger</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>先这样定义 <code>setupDebugMessenger</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupDebugMessenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!enableValidationLayers) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要用关于<em>信使</em>和其回调的细节填充一个结构体，创建 <code>populateDebugMessengerCreateInfo</code> 函数并在 <code>setupDebugMessenger</code> 函数中添加初始化和调用：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:125-131</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">populateDebugMessengerCreateInfo</span><span class="params">(VkDebugUtilsMessengerCreateInfoEXT&amp; createInfo)</span> </span>{</span><br><span class="line">    createInfo = {};</span><br><span class="line">    createInfo.sType = VK_STRUCTURE_TYPE_DEBUG_UTILS_MESSENGER_CREATE_INFO_EXT;</span><br><span class="line">    createInfo.messageSeverity = VK_DEBUG_UTILS_MESSAGE_SEVERITY_VERBOSE_BIT_EXT | VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT | VK_DEBUG_UTILS_MESSAGE_SEVERITY_ERROR_BIT_EXT;</span><br><span class="line">    createInfo.messageType = VK_DEBUG_UTILS_MESSAGE_TYPE_GENERAL_BIT_EXT | VK_DEBUG_UTILS_MESSAGE_TYPE_VALIDATION_BIT_EXT | VK_DEBUG_UTILS_MESSAGE_TYPE_PERFORMANCE_BIT_EXT;</span><br><span class="line">    createInfo.pfnUserCallback = debugCallback;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:136-137</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VkDebugUtilsMessengerCreateInfoEXT createInfo;</span><br><span class="line"><span class="built_in">populateDebugMessengerCreateInfo</span>(createInfo);</span><br></pre></td></tr></table></figure>
<p>需要填充的 <code>VkDebugUtilsMessengerCreateInfoEXT</code> 对象 <code>createInfo</code> 的成员：</p>
<ul>
<li><code>sType</code>：结构体类型</li>
<li><code>messageSeverity</code>：指定会触发回调函数的信息的严重性</li>
<li><code>messageType</code>：指定会触发回调函数的信息的类型</li>
<li><code>pfnUserCallback</code>：回调函数</li>
<li><code>pUserData</code>：用户数据，可选，会被传递给前面的 <code>debugCallback</code> 函数的同名参数</li>
</ul>
<div class="note info"><p>还有其他许多方式可以用来配置验证层的消息和调试回调，详见 <span class="exturl" data-url="aHR0cHM6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvdnVsa2FuL3NwZWNzLzEuMS1leHRlbnNpb25zL2h0bWwvdmtzcGVjLmh0bWwjVktfRVhUX2RlYnVnX3V0aWxz">extension specification<i class="fa fa-external-link-alt"></i></span>。</p>
</div>
<p>填充完成后就是将结构体传递给 <code>vkCreateDebugUtilsMessengerEXT</code> 函数以创建 <code>VkDebugUtilsMessengerEXT</code> 对象。不幸的是，该函数是一个扩展函数，不会自动加载，我们需要使用 <code>vkGetInstanceProcAddr</code> 函数来手动查找其地址。这里我们添加了一个 <code>CreateDebugUtilsMessengerEXT</code> 代理函数来在幕后进行处理：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:23-30</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VkResult <span class="title">CreateDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance, <span class="keyword">const</span> VkDebugUtilsMessengerCreateInfoEXT* pCreateInfo, <span class="keyword">const</span> VkAllocationCallbacks* pAllocator, VkDebugUtilsMessengerEXT* pDebugMessenger)</span> </span>{</span><br><span class="line">    <span class="keyword">auto</span> func = (PFN_vkCreateDebugUtilsMessengerEXT) <span class="built_in">vkGetInstanceProcAddr</span>(instance, <span class="string">&quot;vkCreateDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">func</span>(instance, pCreateInfo, pAllocator, pDebugMessenger);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> VK_ERROR_EXTENSION_NOT_PRESENT;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果 <code>vkCreateDebugUtilsMessengerEXT</code> 加载失败，<code>vkGetInstanceProcAddr</code> 会返回 <code>nullptr</code>。</p>
</blockquote>
<p>现在可以在 <code>setupDebugMessenger</code> 函数中调用 <code>CreateDebugUtilsMessengerEXT</code> 函数了：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:139-141</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">CreateDebugUtilsMessengerEXT</span>(instance, &amp;createInfo, <span class="literal">nullptr</span>, &amp;debugMessenger) != VK_SUCCESS) {</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to set up debug messenger!&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>倒数第二个参数又是是配置器回调，我们这次也将其设置为 <code>nullptr</code>。由于<em>调试信使</em>特定于 Vulkan 实例，所以需要通过第一个参数显式指定。你会在后面的其他<em>子对象</em>（child objects）中也看到这种模式。其他参数相当直白，无需多余解释。</p>
<blockquote>
<p>这是 <code>setupDebugMessenger</code> 函数最终的样子：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:133-142</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupDebugMessenger</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!enableValidationLayers) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    VkDebugUtilsMessengerCreateInfoEXT createInfo;</span><br><span class="line">    <span class="built_in">populateDebugMessengerCreateInfo</span>(createInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CreateDebugUtilsMessengerEXT</span>(instance, &amp;createInfo, <span class="literal">nullptr</span>, &amp;debugMessenger) != VK_SUCCESS) {</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to set up debug messenger!&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>VkDebugUtilsMessengerEXT</code> 对象需要通过调用 <code>vkDestroyDebugUtilsMessengerEXT</code> 来清除。类似于 <code>vkCreateDebugUtilsMessengerEXT</code>，该函数也需要手动加载。我们在 <code>CreateDebugUtilsMessengerEXT</code> 后面又创建了一个函数来进行处理：</p>
</blockquote>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:32-37</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DestroyDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance, VkDebugUtilsMessengerEXT debugMessenger, <span class="keyword">const</span> VkAllocationCallbacks* pAllocator)</span> </span>{</span><br><span class="line">    <span class="keyword">auto</span> func = (PFN_vkDestroyDebugUtilsMessengerEXT) <span class="built_in">vkGetInstanceProcAddr</span>(instance, <span class="string">&quot;vkDestroyDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) {</span><br><span class="line">        <span class="built_in">func</span>(instance, debugMessenger, pAllocator);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>确保该函数是一个静态成员函数或是一个在类外的函数，以便在 <code>cleanup</code> 函数中调用：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:74-84</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (enableValidationLayers) {</span><br><span class="line">        <span class="built_in">DestroyDebugUtilsMessengerEXT</span>(instance, debugMessenger, <span class="literal">nullptr</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vkDestroyInstance</span>(instance, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwDestroyWindow</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwTerminate</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="debugging-instance-creation-and-destruction">Debugging instance creation and destruction<a class="markdownIt-Anchor" href="#debugging-instance-creation-and-destruction"></a></h4>
<p>现在我们用验证层为程序添加了调试功能，但是并没有覆盖整个程序。<code>vkCreateDebugUtilsMessengerEXT</code> 的调用需要一个已创建的有效实例，<code>vkDestroyDebugUtilsMessengerEXT</code> 则必须在实例销毁前被调用。这使我们无法处理 <code>vkCreateInstance</code> 和 <code>vkDestroyInstance</code> 中出现的问题。</p>
<p>然而如果你详细阅读了 <span class="exturl" data-url="aHR0cHM6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvdnVsa2FuL3NwZWNzLzEuMS1leHRlbnNpb25zL2h0bWwvdmtzcGVjLmh0bWwjVktfRVhUX2RlYnVnX3V0aWxz">extension specification<i class="fa fa-external-link-alt"></i></span>，你会发现一个专门为这两个函数创建独立调试信使的方法。你只需要简单地传递一个指向一个 <code>VkDebugUtilsMessengerCreateInfoEXT</code> 结构体的指针给 <code>VkInstanceCreateInfo</code> 的 <code>pNext</code> 成员。我们已经将填充信使创建信息的代码抽出到了一个单独的函数 <code>populateDebugMessengerCreateInfo</code> 中，可以在 <code>createInstance</code> 函数中使用该函数：</p>
<figure class="highlight cpp"><figcaption><span>02_validation_layers.cpp:107-118</span><a href="/code/Vulkan/02_validation_layers.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">VkDebugUtilsMessengerCreateInfoEXT debugCreateInfo{};</span><br><span class="line"><span class="keyword">if</span> (enableValidationLayers) {</span><br><span class="line">    createInfo.enabledLayerCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(validationLayers.<span class="built_in">size</span>());</span><br><span class="line">    createInfo.ppEnabledLayerNames = validationLayers.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">populateDebugMessengerCreateInfo</span>(debugCreateInfo);</span><br><span class="line">    createInfo.pNext = (VkDebugUtilsMessengerCreateInfoEXT*) &amp;debugCreateInfo;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    createInfo.enabledLayerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    createInfo.pNext = <span class="literal">nullptr</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>注意 <code>debugCreateInfo</code> 被放在了 if-else 结构外以确保其不会在调用 <code>vkCreateInstance</code> 前被销毁。这样创建的的信使会在自动在 <code>vkCreateInstance</code> 和 <code>vkDestroyInstance</code> 被使用并在之后被自动销毁。</p>
<h4 id="testing">Testing<a class="markdownIt-Anchor" href="#testing"></a></h4>
<p>现在我们来故意引入一些错误：暂时移除 <code>cleanup</code> 中的 <code>DestroyDebugUtilsMessengerEXT</code> 调用并编译运行你的程序。程序退出时你应该会看到类似这样的信息：</p>
<img data-src="/Learning/Computer/Computer-Graphics/Vulkan/Validation_layer_error_testing.png" class="">
<div class="note warning"><p>再次提醒：对 ArchLinux 用户，请确认你安装了 vulkan-devel 软件包或单独安装了 vulkan-validation-layers 软件包；其他发行版的用户也需确保 Validation Layers 已安装。参考 <span class="exturl" data-url="aHR0cHM6Ly92dWxrYW4ubHVuYXJnLmNvbS9kb2Mvdmlldy8xLjIuMTMxLjEvd2luZG93cy9nZXR0aW5nX3N0YXJ0ZWQuaHRtbCN1c2VyLWNvbnRlbnQtdmVyaWZ5LXRoZS1pbnN0YWxsYXRpb24=">Verify the Installation<i class="fa fa-external-link-alt"></i></span>。</p>
</div>
<h4 id="configuration">Configuration<a class="markdownIt-Anchor" href="#configuration"></a></h4>
<p>除了在 <code>VkDebugUtilsMessengerCreateInfoEXT</code> 中设置标志外，还可以对验证层的行为进行许多其他设置。查看 Vulkan SDK 中的 <code>Config</code> 目录，其中的 <code>vk_layer_settings.txt</code> 说明了如何进行设置。要为单独的程序进行设置，可将文件复制到项目的 <code>Debug</code> 和 <code>Release</code> 目录。</p>
<h3 id="physical-devices-and-queue-families">Physical devices and queue families<a class="markdownIt-Anchor" href="#physical-devices-and-queue-families"></a></h3>
<h4 id="selecting-a-physical-device">Selecting a physical device<a class="markdownIt-Anchor" href="#selecting-a-physical-device"></a></h4>
<p>通过 <code>VkInstance</code></p>
<h4 id=""><a class="markdownIt-Anchor" href="#"></a></h4>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Qihuan Liu
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/" title="Vulkan">https://www.aloha.org.cn/Learning/Computer/Computer-Graphics/Vulkan/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Index/" rel="tag"><i class="fa fa-tag"></i> Index</a>
              <a href="/tags/Computer-Graphics/" rel="tag"><i class="fa fa-tag"></i> Computer Graphics</a>
              <a href="/tags/Vulkan/" rel="tag"><i class="fa fa-tag"></i> Vulkan</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Learning/Computer/C-C/C-%E6%8B%BE%E9%81%97/" rel="prev" title="C++ 拾遗">
                  <i class="fa fa-chevron-left"></i> C++ 拾遗
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Learning/Language/German/%E5%BE%B7%E8%AF%AD/" rel="next" title="德语">
                  德语 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div><script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qihuan Liu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols count total: </span>
    <span title="Symbols count total">231k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">3:30</span>
  </span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script>

<script data-pjax>
$('a.markdownIt-Anchor').parent().mouseenter(function(){$(this).children('a.markdownIt-Anchor').css('visibility','visible')})
$('a.markdownIt-Anchor').parent().mouseleave(function(){$(this).children('a.markdownIt-Anchor').css('visibility','hidden')})
</script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="pdf" type="application/json">{&quot;object_url&quot;:{&quot;url&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;pdfobject@2.2.5&#x2F;pdfobject.min.js&quot;,&quot;integrity&quot;:&quot;sha256-YuNlP9i6s&#x2F;WH7EaU2kErloo9Vc85C3WVqhoMDgsEVpY&#x3D;&quot;},&quot;url&quot;:&quot;&#x2F;lib&#x2F;pdf&#x2F;web&#x2F;viewer&quot;}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{&quot;enable&quot;:true,&quot;theme&quot;:&quot;forest&quot;,&quot;js&quot;:{&quot;url&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;mermaid@8.9.3&#x2F;dist&#x2F;mermaid.min.js&quot;,&quot;integrity&quot;:&quot;sha256-OyJHvRcZHaRR6Ig73ppxF4QXk8HzvfgTprRWkulCkfY&#x3D;&quot;}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="nprogress" type="application/json">{&quot;enable&quot;:true,&quot;spinner&quot;:true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.3/dist/katex.min.css" integrity="sha256-ZtdsMkDnoWbkrm82KV9pXHJCBx4mzAuAkBEMswmVH5M=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.3/dist/contrib/copy-tex.min.css" integrity="sha256-+oItviPaTmqjDhk4y4fLLUIMgRQYDV/ZyrRNvQiebWM=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{&quot;copy_tex_js&quot;:{&quot;url&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;katex@0.13.3&#x2F;dist&#x2F;contrib&#x2F;copy-tex.min.js&quot;,&quot;integrity&quot;:&quot;sha256-etSqbSVF4+Lwe8MGk&#x2F;Vanc1sR+mWv+qOG73fxWw9p94&#x3D;&quot;}}</script>
  <script src="/js/third-party/math/katex.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{&quot;enable&quot;:true,&quot;repo&quot;:&quot;alohaia&#x2F;alohaia.github.io&quot;,&quot;issue_term&quot;:&quot;title&quot;,&quot;theme&quot;:&quot;preferred-color-scheme&quot;}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
